window.addEventListener("contextmenu",(e=>e.preventDefault())),document.addEventListener("dragstart",(e=>e.preventDefault()));const PlayerStatsManager={pendingStats:{},saveTimeout:null,lastSaveTime:0,SAVE_DELAY:5e3,lastSubmitTime:0,SUBMIT_DELAY:1e3,init(){document.addEventListener("visibilitychange",(()=>{"hidden"===document.visibilityState?(this.forceSave(),turnOnPause()):turnOffPause()})),window.addEventListener("beforeunload",(()=>{this.forceSave()}))},update(e){this.pendingStats={...this.pendingStats,...e};const t=Date.now()-this.lastSaveTime;t>=this.SAVE_DELAY?this.save():(clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout((()=>this.save()),this.SAVE_DELAY-t))},prepareChanges(){const e={bestScore:game.bestScore,hasEnteredBefore:!0,playDays:game.playDays,displayMode:game.displayMode,lastClaimDate:game.lastClaimDate,lastDailyReward:game.lastDailyReward,currentGame:{...getSnapshotBoard(),history:game.historyStack.map((e=>({score:e.score||0,collectedDice:e.collectedDice||0,highestLevelReached:e.highestLevelReached||0,grid:e.grid.map((e=>e.map((e=>e?{value:e.value}:null))))})))}};this.update(e)},async save(){try{await sdkWrapper.setData(this.pendingStats),this.pendingStats={},this.lastSaveTime=Date.now()}catch(e){}},forceSave(){Object.keys(this.pendingStats).length>0&&this.save()},async trySubmitScore(e){if(!this.isAuthorized)return;const t=Date.now();t-this.lastSubmitTime<this.SUBMIT_DELAY||(this.lastSubmitTime=t,await sdkWrapper.submitScore("lbBestScore",e))}},SoundManager={sounds:{},audioContext:null,init(){this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext))},async load(e,t){this.init();try{const a=await fetch(t),o=await a.arrayBuffer(),n=await this.audioContext.decodeAudioData(o);this.sounds[e]={buffer:n,source:null,startTime:0,pausedAt:0}}catch(e){}},play(e,{loop:t=!1,volume:a=1}={}){const o=this.sounds[e];if(!o)return;o.source&&(o.source.stop(),o.source.disconnect()),o.source=this.audioContext.createBufferSource(),o.source.buffer=o.buffer,o.source.loop=t;const n=this.audioContext.createGain();n.gain.value=a,o.source.connect(n),n.connect(this.audioContext.destination),o.source.start(0,o.pausedAt),o.startTime=this.audioContext.currentTime-o.pausedAt},pause(e){const t=this.sounds[e];t?.source&&(t.pausedAt=this.audioContext.currentTime-t.startTime,t.source.stop(),t.source.disconnect(),t.source=null)},stop(e){const t=this.sounds[e];t&&(t.source&&(t.source.stop(),t.source.disconnect(),t.source=null),t.pausedAt=0)}},game={preloaderImages:[],grid:[],gap:2,tileSize:0,cellSize:0,gridSize:5,getRandomTileValue:null,typeModes:{level:"level",value:"value"},displayMode:null,highestLevelReached:2,gridElement:document.getElementById("grid"),settingsOverlay:document.getElementById("settings-overlay"),elBestScore:document.getElementById("best"),elScore:document.getElementById("score"),"elСollectedDice":document.getElementById("collected-dice"),destroyPanel:document.getElementById("destroy-mode-panel"),swapPanel:document.getElementById("swap-mode-panel"),gameOverOverlay:document.getElementById("game-over-overlay"),selectedTiles:[],historyStack:[],HISTORY_LIMIT:10,soundPermitted:!1,isSoundOn:!1,swapMode:!1,destroyMode:!1,isPlaying:!1,isOverlay:!1,isMove:!1,isPaused:!1,hasEnteredBefore:!1,bestScore:0,score:0,collectedDice:0,lastClaimDate:null,lastDailyReward:null,playDays:0,player:{},isAuthorized:!1,log2Cache:{},colorCache:{},predefinedTileColors:{},randomLevelUpPhrases:[],randomNoCurrencyPhrases:[],lang:null,langs:["ru","en"],currentLang:"ru",translations:{},dailyReward:395,videoReward:450,undoPrice:20,destroyPrice:35,swapPrice:25,lastAdTimestamp:0,lastInteractionTime:null,intervalSmartAd:18e4,displayOfAds:!1};async function initGame(e){createGrid(),initTilePool(),syncTileSizeWithCell(),initDefaultSettings(),game.getRandomTileValue=(()=>{const e=[2,4,8,16,32,64],t=[50,40,25,3,2,1],a=t.reduce(((e,t)=>e+t));return function(){const o=Math.random()*a;let n=0;for(let a=0;a<e.length;a++)if(n+=t[a],o<n)return e[a]}})(),game.isSoundOn="false"!==localStorage.getItem("sound"),game.lastAdTimestamp=Number(localStorage.getItem("lastAdTimestamp")||0),updateLabelSound(),game.isAuthorized=sdkWrapper.isAuthorized,await loadCloudSave();let t=!0;for(let e=0;e<game.gridSize;e++){for(let a=0;a<game.gridSize;a++)if(game.grid[e][a]){t=!1;break}if(!t)break}if(t&&setTimeout((()=>{spawnTile(),spawnTile()}),200),game.hasEnteredBefore){const e=(new Date).toISOString().split("T")[0];game.lastClaimDate.toISOString().split("T")[0]!==e&&(game.playDays=(game.playDays||1)+1)}else game.hasEnteredBefore=!0,game.playDays=1;SoundManager.load("destroy",["sound/destroy.mp3"]),SoundManager.load("swap",["sound/swap.mp3"]),SoundManager.load("undo",["sound/undo.mp3"]),SoundManager.load("levelUp",["sound/levelUp.mp3"]),SoundManager.load("succes",["sound/succes.mp3"]),startGame(),setupInput(),window.addEventListener("orientationchange",checkOrientation),window.addEventListener("resize",(()=>{checkOrientation(),syncTileSizeWithCell()})),PlayerStatsManager.init(),document.getElementById("undo-button").addEventListener("click",undoMove),document.getElementById("destroy-button").addEventListener("click",enterDestroyMode),document.getElementById("swap-button").addEventListener("click",enterSwapMode),document.getElementById("settings-button").addEventListener("click",openSettings),document.getElementById("new-game-btn").addEventListener("click",restartGame),document.getElementById("toggle-sound-btn").addEventListener("click",toggleSound),document.getElementById("close-settings-btn").addEventListener("click",closeSettingsOverlay),document.addEventListener("click",allowMusic),window.addEventListener("touchstart",allowMusic),window.addEventListener("keydown",allowMusic),document.body.addEventListener("click",allowMusic,{once:!0}),document.getElementById("go-destroy").onclick=()=>{hiddenGameOverOverlay(),enterDestroyMode()},document.getElementById("go-swap").onclick=()=>{hiddenGameOverOverlay(),enterSwapMode()},document.getElementById("go-undo").onclick=()=>{hiddenGameOverOverlay(),undoMove()},document.getElementById("go-restart").onclick=()=>{hiddenGameOverOverlay(),restartGame()},document.querySelectorAll(".settings-cat").forEach((e=>{e.classList.add("clickable"),e.classList.add("pulse-cat"),e.addEventListener("click",(()=>{e.classList.remove("pulse-cat"),gsap.timeline().to(e,{scale:.9,duration:.05}).to(e,{rotation:gsap.utils.random(-15,15),duration:.08,ease:"power1.inOut"}).to(e,{rotation:0,duration:.1}).to(e,{scale:1,duration:.1});const t=e.getBoundingClientRect();for(let e=0;e<10;e++){const e=document.createElement("div");e.className="particle",document.body.appendChild(e),e.style.left=t.left+t.width/2+"px",e.style.top=t.top+t.height/2+"px";const a=Math.random()*Math.PI*2,o=50+30*Math.random(),n=Math.cos(a)*o,l=Math.sin(a)*o;gsap.to(e,{x:n,y:l,scale:.5+Math.random(),opacity:0,duration:.6,ease:"power2.out",onComplete:()=>e.remove()})}setTimeout((()=>{e.classList.add("pulse-cat")}),800)}))})),document.querySelectorAll("img").forEach((e=>{e.setAttribute("draggable","false")})),game.lastClaimDate=new Date,document.getElementById("btn-play").addEventListener("click",(()=>{document.getElementById("start-screen").style.display="none"})),e&&e()}function isMobile(){return/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)}function checkOrientation(){if(!isMobile())return;const e=window.innerHeight>=window.innerWidth;document.getElementById("rotate-warning").style.display=e?"none":"flex"}function closeSettingsOverlay(){const e=game.settingsOverlay.querySelector(".settings-content");gsap.to(e,{scale:.5,opacity:0,duration:.3,ease:"back.in(1.7)",onComplete:()=>{game.settingsOverlay.classList.add("hidden"),game.isOverlay=!1,tryShowSmartAd()}})}async function loadCloudSave(){const e=await sdkWrapper.getData();return loadStateGame(e),!!e}function loadLocalStorage(){return new Promise(((e,t)=>{const a=localStorage.getItem("progressDiceMerge");if(a){loadStateGame(JSON.parse(a))}e(a)}))}function loadStateGame(e){if(e&&(e.bestScore&&(game.bestScore=e.bestScore),e.hasEnteredBefore&&(game.hasEnteredBefore=e.hasEnteredBefore),e.playDays&&(game.playDays=e.playDays),e.lastClaimDate&&(game.lastClaimDate=new Date(e.lastClaimDate)),e.lastDailyReward&&(game.lastDailyReward=new Date(e.lastDailyReward)),e.currentGame)){const t=e.currentGame;game.score=t.score||0,game.collectedDice=t.collectedDice||0,game.highestLevelReached=t.highestLevelReached||0;for(let e=0;e<game.gridSize;e++)for(let a=0;a<game.gridSize;a++){const o=t.grid[e][a];if(o){const t=document.createElement("div"),n=getLevel(o.value);t.className=`dice dice-${n}`;const l=[0,1,2,3,4,5,6][n];for(let e=0;e<l;e++){const e=document.createElement("div");e.className="dot",t.appendChild(e)}t.dataset.value=o.value,t.dataset.level=n,updateFontSize(t,o.value),game.grid[e][a]={el:t,value:o.value},setTilePosition(t,e,a),styleTile(t,o.value)}}const a=(t.history||[]).map((e=>({score:e.score||0,collectedDice:e.collectedDice||0,highestLevelReached:e.highestLevelReached||0,grid:e.grid.map((e=>e.map((e=>e?{value:e.value}:null))))})));game.historyStack.length=0,game.historyStack.push(...a)}}function initDefaultSettings(){game.predefinedTileColors={1:["#64dfdf","#776e65"],2:["#00af54","#776e65"],3:["#ff595e","#f9f6f2"],4:["#6a4c93","#f9f6f2"],5:["#ffd449","#f9f6f2"],6:["#db3a34","#f9f6f2"],7:["#edcf72","#f9f6f2"],8:["#edcc61","#f9f6f2"],9:["#edc850","#f9f6f2"],10:["#edc53f","#f9f6f2"],11:["#edc22e","#f9f6f2"],12:["#d4af37","#f9f6f2"],13:["#b8860b","#f9f6f2"],14:["#a97142","#f9f6f2"],15:["#8b4513","#f9f6f2"]},game.bestScore=0,game.score=0,game.collectedDice=0,game.hasEnteredBefore=!1,game.playDays=0,game.historyStack=[],game.isPlaying=!1,game.isOverlay=!1,game.isMusicOn=!1,game.musicReady=!1,game.musicStarted=!1,game.lastClaimDate=new Date,game.lastAdTimestamp=0,game.lastInteractionTime=null,setDisplayMode(game.typeModes.level)}function startGame(){updateBestScoreDisplay(),updateScoreDisplay(),updateСollectedDiceDisplay(),game.isPlaying=!0}function updateBestScoreDisplay(){game.elBestScore&&(game.elBestScore.textContent=game.bestScore)}function updateScoreDisplay(){game.elScore&&(game.elScore.textContent=game.score)}function updateСollectedDiceDisplay(){game.elСollectedDice&&(game.elСollectedDice.textContent=game.collectedDice)}function showLevelUpPopup(e){const t=document.getElementById("level-up-popup"),a=document.getElementById("level-up-img"),o=document.getElementById("level-up-text"),n=`images/helper_${Math.floor(8*Math.random())+1}.png`,l=game.preloaderImages[n];l&&a&&(a.src=l.src),o.textContent=getRandomLevelUpPhrase(),t.classList.remove("hidden"),game.isPlaying=!1,gsap.fromTo(t,{scale:.5,opacity:0},{scale:1,opacity:1,duration:.7,ease:"back.out(1.7)",onComplete:()=>{setTimeout((()=>{gsap.to(t,{scale:.5,opacity:0,duration:.3,ease:"back.in(1.7)",onComplete:()=>{t.classList.add("hidden"),game.isPlaying=!0}})}),700)}})}function computeActions(e){const t=[];let a=!1,o=0;const n=game.grid.map((e=>e.map((e=>e?{...e}:null))));const l=(e,t)=>n[e]?.[t],i={ArrowLeft:{vertical:!1,reverse:!1},ArrowRight:{vertical:!1,reverse:!0},ArrowUp:{vertical:!0,reverse:!1},ArrowDown:{vertical:!0,reverse:!0}}[e];if(!i)return{actions:t,moved:a,currency:o};for(let e=0;e<game.gridSize;e++){let n=[];for(let t=0;t<game.gridSize;t++){const a=i.vertical?t:e,o=i.vertical?e:t,s=l(a,o);s&&n.push({...s,r:a,c:o})}i.reverse&&n.reverse();const s=[];let r=0;for(;r<n.length;){const l=n[r],d=n[r+1],c=s.length,m=i.reverse?game.gridSize-1-c:c,u=i.vertical?m:e,g=i.vertical?e:m;d&&l.value===d.value?(l.r==u&&l.c==g||t.push({from:l,from2:void 0,to:{r:u,c:g},value:l.value}),t.push({from:d,from2:l,to:{r:u,c:g},value:2*l.value}),s.push({value:2*l.value}),o+=Math.round(getLevel(l.value)/4),r+=2,a=!0):(l.r===u&&l.c===g||(t.push({from:l,from2:void 0,to:{r:u,c:g},value:l.value}),a=!0),s.push({value:l.value}),r++)}}return{actions:t,moved:a,currency:o}}async function move(e){if(!game.isPlaying)return;if(game.isMove)return;game.isMove=!0;const t=getSnapshotBoard(),{actions:a,moved:o,currency:n}=computeActions(e),l=[],i=[];for(const e of a){const t=getCellElement(e.to.r,e.to.c);if(e.from2){const a=e.from.el,o=getCellElement(e.from.r,e.from.c);game.grid[e.to.r][e.to.c]={el:a,value:e.value},game.grid[e.from.r][e.from.c]=null;const n={r:e.from.r===e.to.r,c:e.from.c===e.to.c},s=animateTileMovement(a,t,n,(()=>{o.contains(a)&&o.removeChild(a),t.contains(e.from2.el)&&t.removeChild(e.from2.el),e.from2.el.remove();const n=getLevel(e.value);a.className=`dice dice-${n} pop`,a.innerHTML="";const l=[0,1,2,3,4,5,6][Math.min(n,6)];for(let e=0;e<l;e++){const e=document.createElement("div");e.className="dot",a.appendChild(e)}a.dataset.value=e.value,a.dataset.level=n,updateFontSize(a,e.value),setTimeout((()=>{a.classList.remove("pop")}),150),styleTile(a,e.value),t.appendChild(a)})).then((()=>{i.push({tile:a,row:e.to.r,col:e.to.c})}));l.push(s)}else{const a=e.from.el,o=getCellElement(e.from.r,e.from.c);game.grid[e.to.r][e.to.c]={el:a,value:e.value},game.grid[e.from.r][e.from.c]=null;const n={r:e.from.r===e.to.r,c:e.from.c===e.to.c},i=animateTileMovement(a,t,n,(()=>{o.contains(a)&&o.removeChild(a),t.appendChild(a)}));l.push(i)}}if(await Promise.all(l),!o)return checkGameOver(),void(game.isMove=!1);setTimeout((()=>{(async()=>{l.length=0;let e={sound:!0};for(const t of i){const a=checkWin(t.row,t.col,e);a&&l.push(a)}l&&await Promise.all(l);const a=game.grid.flat().filter((e=>null===e)).length/(game.gridSize*game.gridSize);a>.75&&spawnTile(),spawnTile(a>.45),pushToHistory(t),PlayerStatsManager.prepareChanges(),checkGameOver(),game.isMove=!1})()}),150)}function cloneGrid(e){return e.map((e=>e.map((e=>e?{el:e.el,value:e.value}:null))))}function getCellElement(e,t){return document.querySelector(`.cell[data-row="${e}"][data-col="${t}"]`)}function checkGameOver(){for(let e=0;e<game.gridSize;e++)for(let t=0;t<game.gridSize;t++){if(!game.grid[e][t])return!1;const a=game.grid[e][t].value;if(e>0&&game.grid[e-1][t]?.value===a||e<game.gridSize-1&&game.grid[e+1][t]?.value===a||t>0&&game.grid[e][t-1]?.value===a||t<game.gridSize-1&&game.grid[e][t+1]?.value===a)return!1}return showGameOverOverlay(),!0}function showGameOverOverlay(){document.getElementById("stat-score").textContent=game.score,document.getElementById("stat-dice").textContent=game.collectedDice,document.getElementById("stat-best").textContent=game.bestScore,game.gameOverOverlay.classList.remove("hidden"),game.isOverlay=!0}function hiddenGameOverOverlay(){game.gameOverOverlay.classList.add("hidden"),game.isOverlay=!1}function getNewValue(){let e;const t=Math.random();return e=t<.5?2:t<.8?4:8,e}function spawnTile(e=!0){const t=[];for(let e=0;e<game.gridSize;e++)for(let a=0;a<game.gridSize;a++)game.grid[e][a]||t.push({r:e,c:a});if(0===t.length)return;const{r:a,c:o}=t[Math.floor(Math.random()*t.length)],n=e?game.getRandomTileValue():getNewValue(),l=getLevel(n),i=document.createElement("div");i.style.display="none",i.className=`dice dice-${l}`,i.innerHTML="";const s=[0,1,2,3,4,5,6][l];for(let e=0;e<s;e++){const e=document.createElement("div");e.className="dot",i.appendChild(e)}i.dataset.value=n,i.dataset.level=l,updateFontSize(i,n),game.grid[a][o]={el:i,value:n},setTilePosition(i,a,o),styleTile(i,n),i.style.display="",i.classList.add("pop"),setTimeout((()=>{i.classList.remove("pop")}),150)}function checkWin(e,t,a){const o=game.grid[e][t];if(!o)return null;const n=o.el,l=getLevel(o.value);if(l<=6)return addScore(2*(l-1)),null;game.grid[e][t]=null,PlayerStatsManager.prepareChanges();const i=getTilePosition(n),s=getFreeAnimationTile();cleanAnimationTile(s);const r=n.getBoundingClientRect(),d=document.getElementById("tile-animation-layer").getBoundingClientRect(),c=(document.querySelector(".cell").getBoundingClientRect(),+(.05*r.width).toFixed(2)),m=r.left-d.left-c,u=r.top-d.top-c;d.left,d.top;s.classList.add("dice-"+n.dataset.level),s.innerHTML=n.innerHTML,s.style.background=n.style.background,s.style.color=n.style.color,s.style.fontSize=n.style.fontSize,s.style.transform="none",s.dataset.value=n.dataset.value,s.dataset.level=n.dataset.level,updateFontSize(s,n.dataset.value),gsap.set(s,{position:"absolute",opacity:1,zIndex:100,top:`${u}px`,left:`${m}px`,display:"grid",onComplete:()=>{n.style.display="none"}});const g=game.elScore.getBoundingClientRect(),p=g.left+g.width/2-d.left-s.offsetWidth/2,y=g.top+g.height/2-d.top-s.offsetHeight/2;return a.sound&&(playSound("levelUp"),a.sound=!1),gsap.to(s,{left:p,top:y,duration:1,opacity:0,ease:"power1.inOut",onComplete:()=>{n.style.display="none",i.cellEl.removeChild(n),n.remove(),s.style.display="none",s.style.transform="none",addScore(o.value),addCollectedDice(),game.elScore.style.display="inline-block",game.elСollectedDice.style.display="inline-block",gsap.fromTo([game.elScore,game.elСollectedDice],{scale:1,color:"##014f86"},{scale:.7,color:"#edcf72",duration:.3,ease:"power1.out",yoyo:!0,repeat:1,onComplete:()=>{game.elScore.style.display="",game.elСollectedDice.style.display=""}})}})}function createGrid(){document.documentElement.style.setProperty("--grid-size",game.gridSize);for(let e=0;e<game.gridSize;e++){game.grid[e]=[];for(let t=0;t<game.gridSize;t++){const a=document.createElement("div");a.className="cell",a.dataset.row=e,a.dataset.col=t,game.gridElement.appendChild(a),game.grid[e][t]=null}}syncTileSizeWithCell()}function syncTileSizeWithCell(){adjustGameContainerMargin();const e=document.querySelector(".cell");if(!e)return;const t=e.getBoundingClientRect();game.tileSize=(e=>{const t=window.innerWidth,a=window.innerHeight;return e/Math.min(t,a)*100})(t.width);document.documentElement.style.setProperty("--tile-size",`${game.tileSize.toFixed(2)}vmin`);for(let e=0;e<game.gridSize;e++)for(let t=0;t<game.gridSize;t++){const a=game.grid[e][t];a&&setTilePosition(a.el,e,t)}}function adjustGameContainerMargin(){const e=document.getElementById("game-wrapper"),t=document.querySelector(".top-panel"),a=document.querySelector(".game-container"),o=document.querySelector(".bottom-buttons");if(!(e&&t&&a&&o))return;const n=getComputedStyle(o),l=parseFloat(n.marginTop),i=e.clientHeight-t.offsetHeight-a.offsetHeight-(o.offsetHeight+l);if(i>0){const e=Math.min(i/window.innerHeight*100,15);a.style.marginTop=`${e}vmin`}else a.style.marginTop="0"}function setTilePosition(e,t,a){const o=game.gridElement.querySelector(`.cell[data-row="${t}"][data-col="${a}"]`);o&&o.appendChild(e)}function styleTile(e,t){const a=getLevel(t),[o,n]=getColorForLevel(a);e.style.background=o,e.style.color=n,e.style.background=o,e.style.color=n;const l=e.querySelector(".tile-level span");l&&(l.textContent=a),e.style.fontSize=t<100?"7vmin":t<1e3?"6vmin":"5vmin"}function setTileSprite(e,t){const a=getLevel(t);let o;if(a>33){o=`images/helper_${(a-34)%8+1}.png`}else{o=`images/set2/img_${Math.min(a,33)}.png`}const n=game.preloaderImages[o];n&&e&&(e.style.backgroundImage=`url('${n.src}')`)}function getRandomLevelUpPhrase(){return game.randomLevelUpPhrases[Math.floor(Math.random()*game.randomLevelUpPhrases.length)]}function loadingResources(e){preloadImages([],(()=>{fetch(`lang/${game.currentLang}.json`).then((e=>e.json())).then((t=>{game.translations=t,e()}))}))}function preloadImages(e,t){let a=0;const o=e.length;0===e.length&&t(),e.forEach((e=>{const n=new Image;n.onload=n.onerror=()=>{a++,a===o&&t()},n.src=e,game.preloaderImages[e]=n}))}function getLevel(e){if(game.log2Cache[e])return game.log2Cache[e];const t=Math.log2(e);return game.log2Cache[e]=t,t}function getColorForLevel(e){if(game.colorCache[e])return game.colorCache[e];let t;if(game.predefinedTileColors[e])t=game.predefinedTileColors[e];else{t=[`hsl(${35*e%360}, 70%, 60%)`,"#f9f6f2"]}return game.colorCache[e]=t,t}function addScore(e){game.score+=e,updateScoreDisplay(),game.score>game.bestScore&&(game.bestScore=game.score,updateBestScoreDisplay(),PlayerStatsManager.trySubmitScore(game.bestScore))}function addCollectedDice(){game.collectedDice++,updateСollectedDiceDisplay()}function setupInput(){window.addEventListener("keydown",(e=>{game.isOverlay||game.destroyMode||game.swapMode||game.isPaused||["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&(e.preventDefault(),move(e.key))}));const e=document.getElementById("grid"),t=(t,a)=>{const o=e.getBoundingClientRect();return t>=o.left&&t<=o.right&&a>=o.top&&a<=o.bottom};let a,o,n=!1;let l,i;window.addEventListener("touchstart",(e=>{const l=e.touches[0];a=l.clientX,o=l.clientY,n=t(l.clientX,l.clientY)})),window.addEventListener("touchend",(e=>{if(!(game.isOverlay||game.destroyMode||game.swapMode||game.isPaused)){const l=e.changedTouches[0],i=l.clientX,s=l.clientY;if(n||t(i,s)){const e=i-a,t=s-o;Math.max(Math.abs(e),Math.abs(t))>30&&(Math.abs(e)>Math.abs(t)?move(e>0?"ArrowRight":"ArrowLeft"):move(t>0?"ArrowDown":"ArrowUp"))}}n=!1}),{passive:!1});let s=!1;e.addEventListener("mousedown",(e=>{l=e.clientX,i=e.clientY,s=!0})),window.addEventListener("mouseup",(e=>{if(s){if(!(game.isOverlay||game.destroyMode||game.swapMode||game.isPaused)&&null!=l&&null!=i){const t=e.clientX-l,a=e.clientY-i;Math.max(Math.abs(t),Math.abs(a))>30&&(Math.abs(t)>Math.abs(a)?move(t>0?"ArrowRight":"ArrowLeft"):move(a>0?"ArrowDown":"ArrowUp"))}l=i=void 0,s=!1}})),["click","keydown","touchstart"].forEach((e=>{document.addEventListener(e,(()=>{game.lastInteractionTime=Date.now()}))}))}function allowMusic(){game.soundPermitted||SoundManager.init(),game.soundPermitted=!0,document.removeEventListener("click",allowMusic),window.removeEventListener("touchstart",allowMusic),window.removeEventListener("keydown",allowMusic)}function getSnapshotBoard(){return{score:game.score,collectedDice:game.collectedDice,highestLevelReached:game.highestLevelReached,grid:game.grid.map((e=>e.map((e=>e?{value:e.value}:null))))}}function pushToHistory(e){game.historyStack.push(e),game.historyStack.length>game.HISTORY_LIMIT&&game.historyStack.shift()}function undoMove(){if(game.destroyMode||game.swapMode)return;const e=game.historyStack.pop();if(e){playSound("undo"),game.score=e.score||0,game.collectedDice=e.collectedDice||0,game.highestLevelReached=e.highestLevelReached||0,updateScoreDisplay(),updateСollectedDiceDisplay(),updateBestScoreDisplay();for(let t=0;t<game.gridSize;t++)for(let a=0;a<game.gridSize;a++){const o=e.grid[t][a],n=game.grid[t][a];if(o)if(n){const e=getLevel(o.value),l=[0,1,2,3,4,5,6][Math.min(e,6)];for(let e=0;e<l;e++){const e=document.createElement("div");e.className="dot",n.el.appendChild(e)}n.el.className=`dice dice-${e}`,n.el.dataset.value=o.value,n.el.dataset.level=e,updateFontSize(n.el,o.value),styleTile(n.el,o.value),setTilePosition(n.el,t,a),n.value=o.value}else{const e=getLevel(o.value),n=document.createElement("div");n.className=`dice dice-${e}`;const l=[0,1,2,3,4,5,6][Math.min(e,6)];for(let e=0;e<l;e++){const e=document.createElement("div");e.className="dot",n.appendChild(e)}n.dataset.value=o.value,n.dataset.level=e,updateFontSize(n,o.value),styleTile(n,o.value),setTilePosition(n,t,a);getCellElement(t,a).appendChild(n),game.grid[t][a]={el:n,value:o.value}}else n&&(n.el.remove(),game.grid[t][a]=null)}PlayerStatsManager.prepareChanges(),tryShowSmartAd()}}function enterDestroyMode(){game.destroyMode?exitDestroyMode():game.swapMode?exitSwapMode():(game.destroyMode=!0,updateTileCursorState(),game.destroyPanel.classList.remove("hidden"),setTimeout((()=>{document.addEventListener("click",handleDestroyClick)}),50))}function getTilePosition(e){const t=e.closest(".cell");if(!t)return null;return{row:parseInt(t.dataset.row,10),col:parseInt(t.dataset.col,10),cellEl:t}}function handleDestroyClick(e){let t=game.destroyMode;if(exitDestroyMode(),!t)return;const a=e.target.closest(".dice");if(!a)return;const o=getTilePosition(a);if(!o)return;let n=0;for(let e=0;e<game.gridSize;e++)for(let t=0;t<game.gridSize;t++)game.grid[e][t]&&n++;if(n<=1)return;pushToHistory(getSnapshotBoard()),game.grid[o.row][o.col]=null,PlayerStatsManager.prepareChanges();const l=a.style.transform;a.style.transform="none";const i=a.getBoundingClientRect();a.style.transform=l;const s=game.gridElement.getBoundingClientRect(),r=(i.left,s.left,i.top,s.top,a.getBoundingClientRect()),d=r.top+r.width/2,c=r.left+r.height/2;playSound("destroy");for(let e=0;e<15;e++){const e=document.createElement("div");e.className="particle",e.style.boxShadow=`0 0 10px ${e.style.background}`,document.body.appendChild(e),e.style.top=d+"px",e.style.left=c+"px";const t=Math.random()*Math.PI*2,a=80+40*Math.random(),o=Math.cos(t)*a,n=Math.sin(t)*a;gsap.to(e,{x:o,y:n,opacity:.6,scale:1+1.2*Math.random(),duration:.8,ease:"power2.out",onComplete:()=>e.remove()})}gsap.fromTo(a,{opacity:0,scale:.5},{opacity:1,scale:1.2,duration:.1,ease:"power2.out",onComplete:()=>{gsap.to(a,{opacity:0,scale:1.1,duration:.7,ease:"power3.in",onComplete:()=>{a.style.display="none",o.cellEl.removeChild(a),a.remove()}})}}),gsap.fromTo(a,{x:-30},{x:30,yoyo:!0,repeat:5,duration:.04,ease:"power1.inOut",onComplete:()=>{gsap.to(a,{x:0,duration:.05})}})}function exitDestroyMode(){game.destroyMode=!1,updateTileCursorState(),game.destroyPanel.classList.add("hidden"),document.removeEventListener("click",handleDestroyClick)}function updateHelperPanel(e){const t=Math.floor(8*Math.random())+1,a=document.getElementById(e).querySelector(".helper-img"),o=`images/helper_${t}.png`,n=game.preloaderImages[o];n&&a&&(a.src=n.src)}function enterSwapMode(){game.destroyMode?exitDestroyMode():game.swapMode?exitSwapMode():(game.swapMode=!0,updateTileCursorState(),game.selectedTiles=[],game.swapPanel.classList.remove("hidden"),setTimeout((()=>{document.addEventListener("click",handleSwapClick)}),50))}function openSettings(){game.isOverlay=!0;const e=game.settingsOverlay.querySelector(".settings-content");game.settingsOverlay.classList.remove("hidden"),gsap.fromTo(e,{scale:.5,opacity:0},{scale:1,opacity:1,duration:.3,ease:"back.out(1.7)"}),tryShowSmartAd()}function exitSwapMode(){game.swapMode=!1,updateTileCursorState(),game.swapPanel.classList.add("hidden"),document.removeEventListener("click",handleSwapClick),game.selectedTiles.forEach((e=>{game.grid[e.row][e.col].el.classList.remove("selected")})),game.selectedTiles=[]}function handleSwapClick(e){const t=e.target.closest(".dice");if(!t)return void exitSwapMode();const a=getTilePosition(t);if(a&&!game.selectedTiles.some((e=>e.row===a.row&&e.col===a.col))&&(game.selectedTiles.push(a),t.classList.add("selected"),2===game.selectedTiles.length)){pushToHistory(getSnapshotBoard());const[e,t]=game.selectedTiles,a=game.grid[e.row][e.col],o=game.grid[t.row][t.col];if(!a||!o)return;const n=a.el,l=o.el,i={r:e.row===t.row,c:e.col===t.col};animateTileMovement(n,t.cellEl,i,(()=>{e.cellEl.contains(n)&&e.cellEl.removeChild(n),t.cellEl.appendChild(n)})),animateTileMovement(l,e.cellEl,i,(()=>{t.cellEl.contains(l)&&t.cellEl.removeChild(l),e.cellEl.appendChild(l)})),playSound("swap"),[game.grid[e.row][e.col],game.grid[t.row][t.col]]=[o,a],n.classList.remove("selected"),l.classList.remove("selected"),game.selectedTiles=[],exitSwapMode(),PlayerStatsManager.prepareChanges()}}function t(e,t={}){let a=game.translations[e]||e;for(const e in t)a=a.replaceAll(`{${e}}`,t[e]);return a}function updateLangTexts(){document.getElementById("undo-button").title=t("undo"),document.getElementById("destroy-button").title=t("destroy"),document.getElementById("swap-button").title=t("swap"),document.getElementById("settings-button").title=t("settings"),document.getElementById("new-game-btn").querySelector("span").textContent=t("newGame"),document.getElementById("toggle-sound-btn").querySelector("span").textContent=t("sound"),document.getElementById("close-settings-btn").querySelector("span").textContent=t("continue"),document.getElementById("go-restart").querySelector("span").textContent=t("newGame"),document.getElementById("title-game-over-1").textContent=t("title-game-over-1"),document.getElementById("title-game-over-2").textContent=t("title-game-over-2"),game.destroyPanel.querySelector("p").textContent=t("destroyInstruction"),game.swapPanel.querySelector("p").textContent=t("swapInstruction")}function restartGame(){game.score=0,game.collectedDice=0,game.historyStack.length=0,game.highestLevelReached=2,game.gridElement.innerHTML="",game.grid=[],createGrid(),setTimeout((()=>{spawnTile(),spawnTile(),PlayerStatsManager.prepareChanges(),game.lastClaimDate=new Date,game.isOverlay=!1,game.isPlaying=!0}),500),updateBestScoreDisplay(),updateScoreDisplay(),updateСollectedDiceDisplay(),closeSettingsOverlay(),tryShowSmartAd("newgame")}function toggleSound(){game.isSoundOn=!game.isSoundOn,localStorage.setItem("sound",game.isSoundOn),updateLabelSound()}function updateLabelSound(){document.getElementById("sound-text").textContent=game.isSoundOn?t("soundOn"):t("soundOff");document.getElementById("sound-icon").src=game.isSoundOn?"images/icon_sound_on.png":"images/icon_sound_off.png"}function checkDailyReward(){const e=(new Date).toDateString();game.lastDailyReward&&game.lastDailyReward.toDateString()===e||setTimeout((()=>{const e=game.dailyReward;showRewardPopup(t("dailyReward",{amount:e}),(()=>{game.currency+=e,game.lastDailyReward=new Date,updateCurrencyDisplay()}))}),1e3)}function showRewardPopup(e,t){const a=document.createElement("div");a.className="level-up-popup",a.innerHTML=`\n    <img src="images/diamond.png" />\n    <p>${e}</p>\n  `,document.body.appendChild(a),gsap.fromTo(a,{scale:.5,opacity:0},{scale:1,opacity:1,duration:.6,ease:"back.out(1.7)",onComplete:()=>{setTimeout((()=>{gsap.to(a,{scale:.5,opacity:0,duration:.4,ease:"back.in(1.7)",onComplete:()=>{a.remove(),t&&t()}})}),2500)}})}function tryShowSmartAd(e="auto"){if(game.displayOfAds)return;const t=Date.now(),a=t-game.lastAdTimestamp,o="auto"===e,n="startup"===e,l="newgame"===e;if(o){if(a<game.intervalSmartAd)return;if(game.destroyMode||game.swapMode)return;if(game.playDays<5&&(game.isAuthorized||game.playDays>1)){if(4===game.playDays&&a<game.intervalSmartAd+6e4)return;if(3===game.playDays&&a<game.intervalSmartAd+12e4)return;if(2===game.playDays&&a<game.intervalSmartAd+18e4)return;if(a<game.intervalSmartAd+2e5)return}}else{if(n&&a<24e4)return;if(l&&a<6e4)return}(n||l||o)&&(game.lastAdTimestamp=t,localStorage.setItem("lastAdTimestamp",t.toString()))}function showFullscreenAd(e=!1,t=null){ysdk?.adv&&!game.displayOfAds&&(turnOnPause(),setTimeout((()=>{ysdk.adv.showFullscreenAdv({callbacks:{onOpen:()=>{game.displayOfAds=!0},onClose:e=>{game.displayOfAds=!1,turnOffPause(),e&&(game.lastAdTimestamp=Date.now()),t&&t?.()},onError:e=>{t&&t?.()}}})}),e?250:1))}function turnOnPause(){game.isPaused=!0}function turnOffPause(){game.isPaused=!1}function playSound(e){game.soundPermitted&&game.isSoundOn&&SoundManager.play(e)}function playVictoryParticles(e,t){for(let a=0;a<50;a++){const a=document.createElement("div");a.className="particle",document.body.appendChild(a),a.style.left=`${e}px`,a.style.top=`${t}px`,a.style.background=`hsl(${360*Math.random()}, 90%, 60%)`;const o=Math.random()*Math.PI*2,n=40+40*Math.random(),l=Math.cos(o)*n,i=Math.sin(o)*n;gsap.to(a,{x:l,y:i,opacity:0,scale:.5+Math.random(),duration:.5+Math.random(),ease:"power2.out",onComplete:()=>a.remove()})}}function initTilePool(){game.tilePool=[];const e=document.getElementById("tile-animation-layer");for(let t=0;t<game.gridSize*game.gridSize;t++){const t=document.createElement("div");t.className="dice animation-dice",t.style.position="absolute",t.style.display="none",t.dataset.isActive="0",e.appendChild(t),game.tilePool.push(t)}}function getFreeAnimationTile(){return game.tilePool.find((e=>"none"===e.style.display&&"0"===e.dataset.isActive))}function cleanAnimationTile(e){e.className="dice animation-dice",e.innerHTML="",e.style.background="",e.style.color="",e.style.fontSize="",e.style.zIndex="0",e.style.opacity="1",e.style.scale="1",e.style.top="0",e.style.left="0",e.style.display="none",e.dataset.value="",e.dataset.level=""}function animateTileMovement(e,t,a,o){const n=getFreeAnimationTile();if(!n)return o?.(),Promise.resolve();if(n.dataset.isActive="1",cleanAnimationTile(n),!game.tileDelta){const e=e=>{const t=window.innerWidth,a=window.innerHeight;return e/Math.min(t,a)*100},t=n.getBoundingClientRect();game.tileDelta=(game.tileSize-e(t.width))/2}const l=t.getBoundingClientRect(),i=document.getElementById("tile-animation-layer").getBoundingClientRect(),s=l.left-i.left,r=l.top-i.top;let d=s,c=r;if(!a.r||!a.c){const t=e.getBoundingClientRect();a.r||(c=t.top-i.top-game.tileDelta),a.c||(d=t.left-i.left-game.tileDelta)}return n.classList.add("dice-"+e.dataset.level),n.innerHTML=e.innerHTML,n.dataset.value=e.dataset.value,n.dataset.level=e.dataset.level,updateFontSize(n,e.dataset.value),gsap.set(n,{x:0,y:0,position:"absolute",top:`${c}px`,left:`${d}px`,zIndex:100,opacity:1,transform:"none",display:"grid",background:e.style.background,color:e.style.color,fontSize:e.style.fontSize,onComplete:()=>{e.style.display="none"}}),gsap.to(n,{x:s-d,y:r-c,duration:.25,ease:"power1.inOut",onComplete:()=>{o?.(),n.style.display="none",n.style.transform="none",n.dataset.isActive="0",e.style.display="",cleanAnimationTile(n)}})}function updateTileFontSizes(){document.querySelectorAll(".tile").forEach((e=>{const t=e.querySelector(".tile-level span");if(!t)return;const a=.35*e.offsetWidth;t.style.fontSize=a+"px"}))}function setDisplayMode(e){const t=document.querySelector(".game-container");t.classList.remove("display-level","display-value"),t.classList.add("display-"+e),game.displayMode=e}function updateFontSize(e,t){const a=t.toString().length;e.classList.forEach((t=>{t.startsWith("len-")&&e.classList.remove(t)})),e.classList.add(`len-${a}`)}function burstSprites({spriteUrl:e="❤️",duration:t=2e3,rate:a=80,width:o=24,height:n=24}={}){const l=performance.now();!function i(){if(performance.now()-l>t)return;const s=document.createElement("div");s.className="effect-sprite",s.style.position="absolute",s.style.width=o+"px",s.style.height=n+"px",s.style.left=Math.random()*window.innerWidth+"px",s.style.top="-40px",s.style.pointerEvents="none",s.style.zIndex="999",e.startsWith("http")||e.includes("/")?(s.style.backgroundImage=`url('${e}')`,s.style.backgroundSize="cover"):(s.innerHTML=e,s.style.fontSize=o+"px"),document.body.appendChild(s),gsap.to(s,{y:window.innerHeight+50,x:"+="+(100*Math.random()-50),rotation:360*Math.random(),opacity:0,duration:2+Math.random(),ease:"power1.out",onComplete:()=>s.remove()}),setTimeout(i,1e3/a)}()}function updateTileCursorState(){game.destroyMode||game.swapMode?game.gridElement.classList.add("interactive-cursor"):game.gridElement.classList.remove("interactive-cursor")}window.addEventListener("load",(async()=>{checkOrientation(),await sdkWrapper.init("local"),game.lang=sdkWrapper.getLang(),game.currentLang=game.lang&&game.langs.includes(game.lang)?game.lang:game.langs.includes[0],document.documentElement.lang=game.currentLang,loadingResources((async()=>{updateLangTexts(),await initGame((()=>{sdkWrapper.gameReady(),PlayerStatsManager.prepareChanges();const e=document.getElementById("loading-spinner");e&&(e.style.display="none")}))}))}));